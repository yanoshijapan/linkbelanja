<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Belanja Jastip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .animate-shimmer { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #f3f4f6 4%, #e5e7eb 25%, #f3f4f6 36%); background-size: 1000px 100%; }

        .status-pill { @apply px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider transition-all duration-300; }
        .st-pending { @apply bg-red-100 text-red-600 border border-red-200; }
        .st-process { @apply bg-yellow-100 text-yellow-700 border border-yellow-200; }
        .st-done { @apply bg-green-100 text-green-700 border border-green-200; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen selection:bg-blue-100" x-data="app()">

    <header class="glass sticky top-0 z-40 border-b border-gray-200 shadow-sm transition-all duration-300">
        <div class="px-4 py-3 flex justify-between items-center transition-all duration-500" :class="viewMode === 'desktop' ? 'max-w-7xl mx-auto' : ''">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">Y</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">Dashboard Belanja Jastip</h1>
                    <p class="text-[10px] text-gray-500 font-medium">Input Link Belanja</p>
                </div>
            </div>
            <div class="text-[10px] font-mono bg-gray-100 border border-gray-200 px-2 py-1 rounded text-gray-500 transition-colors hover:bg-gray-200 cursor-default" x-text="viewMode.toUpperCase()"></div>
        </div>
    </header>

    <main class="p-4 mx-auto transition-all duration-500 pb-24" :class="viewMode === 'desktop' ? 'max-w-7xl' : 'max-w-md'">

        <div class="bg-white rounded-2xl shadow-xl shadow-gray-200/50 border border-gray-100 mb-8 overflow-hidden transform transition-all hover:shadow-2xl hover:shadow-blue-100/50">
            <div class="p-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100 flex justify-between items-center cursor-pointer" @click="isInputExpanded = !isInputExpanded">
                <h2 class="font-bold text-gray-700 flex items-center gap-2"><span class="text-xl">üõí</span> Input Link Belanja</h2>
                <span class="text-gray-400 text-xl transition-transform duration-300" :class="isInputExpanded ? 'rotate-180' : ''">‚ñº</span>
            </div>
            
            <div x-show="isInputExpanded" x-collapse x-cloak>
                <div class="p-4 sm:p-6">
                    <div class="mb-6 group">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 tracking-wide">Nama Pemesan</label>
                        <input type="text" x-model="userName" class="w-full md:w-1/2 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm" placeholder="Contoh: Budi Santoso">
                    </div>

                    <div class="space-y-4">
                        <template x-for="(item, index) in inputItems" :key="index">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative group hover:border-blue-200 transition-colors duration-300">
                                <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                                    <div class="w-full md:flex-1">
                                        <input type="text" x-model="item.name" class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nama Barang">
                                    </div>
                                    <div class="w-full md:flex-1">
                                        <input type="text" x-model="item.link" class="w-full p-2.5 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Link (URL)">
                                    </div>
                                    <div class="flex gap-2 w-full md:w-auto">
                                        <input type="number" x-model="item.qty" class="w-20 p-2.5 text-sm border border-gray-200 rounded-lg text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Qty">
                                        <button @click="openNoteModal(index)" class="p-2.5 bg-yellow-50 text-yellow-600 border border-yellow-200 rounded-lg hover:bg-yellow-100 active:scale-95">üìù</button>
                                        <button @click="removeInput(index)" class="p-2.5 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 active:scale-95" x-show="inputItems.length > 1">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div x-show="item.note" class="mt-2 text-xs text-gray-500 bg-yellow-50/50 p-2 rounded-lg border border-yellow-100 flex items-center gap-2">
                                    <span class="font-bold text-yellow-600">Catatan:</span> <span x-text="item.note"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-6 flex flex-col md:flex-row gap-3">
                        <button @click="addInput()" class="flex-1 py-3 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl hover:bg-gray-50 hover:border-blue-400 hover:text-blue-500 font-bold transition-all active:scale-95">+ TAMBAH LINK</button>
                        <button @click="submitOrder()" :disabled="isLoading" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all active:scale-95 disabled:opacity-70">
                            <span x-show="!isLoading">SUBMIT LINK</span>
                            <span x-show="isLoading">Sending...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sticky top-[68px] z-30 bg-gray-50/95 backdrop-blur-sm py-2 mb-4 space-y-3">
            <div class="relative">
                <input type="text" x-model="searchQuery" class="w-full pl-10 pr-4 py-3 rounded-xl border-none shadow-sm ring-1 ring-gray-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cari nama barang atau user...">
                <span class="absolute left-3 top-3.5 text-gray-400">üîç</span>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button @click="filterStatus = 'all'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all" :class="filterStatus === 'all' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200'">Semua</button>
                <button @click="filterStatus = 'BELUM DI BELANJAKAN'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all" :class="filterStatus === 'BELUM DI BELANJAKAN' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-500 border-gray-200'">Pending</button>
                <button @click="filterStatus = 'SUDAH DI BELANJAKAN'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all" :class="filterStatus === 'SUDAH DI BELANJAKAN' ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-500 border-gray-200'">Dikirim</button>
                <button @click="filterStatus = 'SUDAH TIBA'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all" :class="filterStatus === 'SUDAH TIBA' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-500 border-gray-200'">Tiba</button>
            </div>
        </div>

        <div x-show="isFetching" class="space-y-4">
            <template x-for="i in 3">
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm space-y-3">
                    <div class="h-4 bg-gray-200 rounded w-1/4 animate-shimmer"></div>
                    <div class="h-6 bg-gray-200 rounded w-3/4 animate-shimmer"></div>
                </div>
            </template>
        </div>

        <div x-show="viewMode === 'mobile' && !isFetching" class="space-y-4">
            <template x-for="(row, index) in filteredItems" :key="row.id">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden transition-all hover:shadow-lg hover:-translate-y-1 duration-300">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide" x-text="formatDate(row.timestamp)"></span>
                            <div class="font-bold text-gray-800 text-lg leading-tight mt-1" x-text="row.item"></div>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-xs text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md font-medium" x-text="row.user"></span>
                            </div>
                        </div>
                        <span class="status-pill" 
                             :class="{ 'st-pending': row.status === 'BELUM DI BELANJAKAN', 'st-process': row.status === 'SUDAH DI BELANJAKAN', 'st-done': row.status === 'SUDAH TIBA' }" 
                             x-text="row.status === 'BELUM DI BELANJAKAN' ? 'PENDING' : (row.status === 'SUDAH DI BELANJAKAN' ? 'DIKIRIM' : 'TIBA')"></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm mt-4">
                        <div class="bg-gray-50 p-2.5 rounded-lg text-center border border-gray-100 flex flex-col">
                            <span class="text-[10px] text-gray-400 uppercase">Jumlah</span>
                            <span class="font-bold text-gray-700" x-text="row.qty"></span>
                        </div>
                        <a :href="row.link" target="_blank" class="bg-blue-50 text-blue-600 p-2.5 rounded-lg text-center border border-blue-100 text-xs flex flex-col items-center justify-center hover:bg-blue-100 transition">
                            <span class="text-[10px] uppercase opacity-70">Produk</span>
                            <span class="font-bold">Buka Link ‚Üó</span>
                        </a>
                    </div>
                    
                    <div x-show="row.note" class="mt-3 text-xs text-gray-500 bg-yellow-50 p-3 rounded-lg border border-yellow-100 relative">
                        <span class="absolute top-0 left-0 w-1 h-full bg-yellow-400 rounded-l-lg"></span>
                        <p class="ml-2" x-text="row.note"></p>
                    </div>

                    <div x-show="row.status !== 'BELUM DI BELANJAKAN'" class="mt-4 pt-4 border-t border-dashed border-gray-200">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-3 text-center">
                            <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-1">Nomor Resi</div>
                            <div class="font-mono font-bold text-gray-900 text-lg tracking-wide mb-2" x-text="row.resi_no || '-'"></div>
                            
                            <div x-show="row.resi_img">
                                <a :href="fixDriveLink(row.resi_img)" target="_blank" class="inline-flex items-center gap-2 bg-white border border-blue-200 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:shadow-md hover:border-blue-400 hover:text-blue-700 transition-all w-full justify-center">
                                    <span>üì∏</span> BUKA FOTO RESI
                                </a>
                            </div>
                            <div x-show="!row.resi_img" class="text-[10px] text-gray-400 italic mt-1">(Foto belum diupload)</div>
                        </div>

                        <button x-show="row.status === 'SUDAH DI BELANJAKAN'" @click="markArrived(row.id)" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-200 transition-all active:scale-95 flex justify-center items-center gap-2">
                            <span>üì¶</span> KONFIRMASI BARANG TIBA
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="viewMode === 'desktop' && !isFetching" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden"
             x-transition:enter="transition ease-out duration-500"
             x-transition:enter-start="opacity-0 translate-y-10"
             x-transition:enter-end="opacity-100 translate-y-0">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                        <th class="p-5 font-bold">Tanggal</th>
                        <th class="p-5 font-bold">Pemesan</th>
                        <th class="p-5 font-bold">Barang</th>
                        <th class="p-5 font-bold text-center">Qty</th>
                        <th class="p-5 font-bold text-center">Link</th>
                        <th class="p-5 font-bold">Catatan</th>
                        <th class="p-5 font-bold text-center">Status & Resi</th>
                        <th class="p-5 font-bold text-center">Ketibaan</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 text-sm">
                    <template x-for="(row, index) in filteredItems" :key="row.id">
                        <tr class="hover:bg-blue-50/50 transition duration-200 group">
                            <td class="p-5 text-gray-500 text-xs whitespace-nowrap" x-text="formatDate(row.timestamp)"></td>
                            <td class="p-5 font-medium text-blue-600" x-text="row.user"></td>
                            <td class="p-5 font-bold text-gray-800" x-text="row.item"></td>
                            <td class="p-5 text-center font-mono text-gray-600" x-text="row.qty"></td>
                            <td class="p-5 text-center"><a :href="row.link" target="_blank" class="text-gray-400 hover:text-blue-600 transition scale-100 hover:scale-125 inline-block">üîó</a></td>
                            <td class="p-5 text-xs text-gray-500 max-w-xs truncate" x-text="row.note || '-'"></td>
                            
                            <td class="p-5 text-center align-top">
                                <div class="flex flex-col items-center gap-2">
                                    <span class="status-pill inline-block" 
                                        :class="{ 'st-pending': row.status === 'BELUM DI BELANJAKAN', 'st-process': row.status === 'SUDAH DI BELANJAKAN', 'st-done': row.status === 'SUDAH TIBA' }" 
                                        x-text="row.status === 'BELUM DI BELANJAKAN' ? 'PENDING' : (row.status === 'SUDAH DI BELANJAKAN' ? 'DIKIRIM' : 'TIBA')"></span>
                                    
                                    <div x-show="row.status !== 'BELUM DI BELANJAKAN'" class="w-full bg-gray-50 p-2 rounded border border-gray-100 text-left">
                                        <div class="text-[10px] text-gray-400 uppercase">Resi:</div>
                                        <div class="font-mono text-xs font-bold text-gray-700" x-text="row.resi_no || '-'"></div>
                                        
                                        <a x-show="row.resi_img" :href="fixDriveLink(row.resi_img)" target="_blank" class="mt-2 block text-[10px] text-center bg-white border border-blue-200 text-blue-600 rounded py-1 font-bold hover:bg-blue-600 hover:text-white transition">
                                            üì∑ LIHAT RESI
                                        </a>
                                    </div>
                                </div>
                            </td>

                            <td class="p-5 text-center align-middle">
                                <button x-show="row.status === 'SUDAH DI BELANJAKAN'" @click="markArrived(row.id)" class="bg-green-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-green-600 shadow-md shadow-green-200 transition active:scale-95">TIBA</button>
                                <span x-show="row.status === 'SUDAH TIBA'" class="text-green-500 text-xl font-bold">‚úì</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="filteredItems.length === 0" class="p-12 text-center text-gray-400 flex flex-col items-center"><span class="text-4xl mb-2 opacity-50">üìÇ</span><p>Tidak ada data yang cocok dengan filter.</p></div>
        </div>

    </main>

    <button @click="toggleView()" class="fixed bottom-6 right-6 z-50 bg-gray-900 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform duration-300 border-4 border-white/20 backdrop-blur">
        <span x-show="viewMode === 'mobile'" class="text-xl">üñ•Ô∏è</span><span x-show="viewMode === 'desktop'" class="text-xl">üì±</span>
    </button>

    <div x-show="isNoteOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/30 backdrop-blur-sm p-4" x-transition.opacity x-cloak>
        <div class="bg-white p-6 rounded-3xl w-full max-w-sm shadow-2xl transform transition-all" @click.away="isNoteOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
            <h3 class="font-bold text-lg mb-4 text-gray-800">Tambahkan Catatan</h3>
            <textarea x-model="inputItems[activeNoteIndex].note" class="w-full p-4 border border-gray-200 rounded-xl h-32 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none bg-gray-50" placeholder="Contoh: Warna Hitam, Size XL..."></textarea>
            <div class="flex justify-end gap-3 mt-6">
                <button @click="isNoteOpen = false" class="px-5 py-2.5 text-gray-500 hover:bg-gray-100 rounded-xl text-sm font-bold transition">Batal</button>
                <button @click="isNoteOpen = false" class="px-5 py-2.5 bg-gray-900 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-black transition active:scale-95">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // === PASTE URL GOOGLE APPS SCRIPT ANDA DI SINI ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbyrRNdad6OJhGMmldEeXPg7ajHuYLvRXRQZwWDib1rtGHkMT-iTGozSvGwjkCKbzZ_P/exec';

        function app() {
            return {
                viewMode: localStorage.getItem('viewMode') || (window.innerWidth > 768 ? 'desktop' : 'mobile'),
                userName: '',
                isFetching: true,
                isLoading: false,
                isInputExpanded: true,
                isNoteOpen: false,
                activeNoteIndex: 0,
                filterStatus: 'all',
                searchQuery: '',
                inputItems: [{ name: '', link: '', qty: '', note: '' }],
                dataItems: [],

                async init() {
                    this.$watch('viewMode', val => localStorage.setItem('viewMode', val));
                    await this.fetchData();
                    setInterval(() => this.fetchData(), 30000); 
                },

                // === FITUR BARU: AUTO-FIX LINK GOOGLE DRIVE ===
                fixDriveLink(url) {
                    if (!url) return '#';
                    // Jika link mengandung 'export=download' atau 'uc?', ubah jadi mode /view
                    if (url.includes('export=download') || url.includes('drive.google.com/uc')) {
                        try {
                            // Coba ambil ID dari parameter 'id='
                            const idMatch = url.match(/id=([^&]+)/);
                            if (idMatch && idMatch[1]) {
                                return `https://drive.google.com/file/d/${idMatch[1]}/view`;
                            }
                        } catch (e) { return url; }
                    }
                    return url;
                },
                // ============================================

                toggleView() { this.viewMode = this.viewMode === 'mobile' ? 'desktop' : 'mobile'; },
                addInput() { this.inputItems.push({ name: '', link: '', qty: '', note: '' }); },
                removeInput(index) { this.inputItems.splice(index, 1); },
                openNoteModal(index) { this.activeNoteIndex = index; this.isNoteOpen = true; },

                async submitOrder() {
                    if (!this.userName) return alert("Isi nama pemesan!");
                    this.isLoading = true;
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'create_order', userName: this.userName, items: this.inputItems })
                        });
                        this.inputItems = [{ name: '', link: '', qty: '', note: '' }];
                        alert("Pesanan berhasil disubmit!");
                        this.fetchData(); 
                    } catch (e) { alert("Gagal kirim: " + e); }
                    this.isLoading = false;
                },

                async fetchData() {
                    try {
                        if(this.dataItems.length === 0) this.isFetching = true;
                        const res = await fetch(API_URL + '?op=read');
                        const data = await res.json();
                        this.dataItems = data;
                    } catch (e) { console.error(e); }
                    this.isFetching = false;
                },

                async markArrived(id) {
                    if(!confirm("Barang sudah diterima?")) return;
                    const item = this.dataItems.find(x => x.id === id);
                    if(item) item.status = 'SUDAH TIBA';
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'update_arrived', id: id })
                    });
                    this.fetchData();
                },

                get filteredItems() {
                    const q = this.searchQuery.toLowerCase();
                    return this.dataItems.filter(i => {
                        const matchSearch = i.item.toLowerCase().includes(q) || i.user.toLowerCase().includes(q);
                        const matchFilter = this.filterStatus === 'all' || i.status === this.filterStatus;
                        return matchSearch && matchFilter;
                    });
                },

                formatDate(isoString) {
                    if(!isoString) return '';
                    return new Date(isoString).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'});
                }
            }
        }
    </script>
</body>
</html>
